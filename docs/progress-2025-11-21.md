# Coupling progress – 2025-11-21

## Overview
- Built coupled WRF in `compilation-20251121`; executables present: `wrf.exe`, `real.exe`, `ideal.exe`, `ndown.exe`, `tc.exe`.
- Kept WRF and SUEWS submodules clean; all edits live in the local build tree, WSPS inputs, and scratch patch dir.
- Updated `module_sf_suews.F` (via coupling-automator) to the current driver and restored SUEWS registry/state wiring so compile succeeds.

## Runtime status
- Test case `compilation-20251121/test/em_quarter_ss` initializes but aborts on first call to SUEWS with `gsModel=0` → "Check input file SUEWS_Conductance.txt." even after simplifying inputs.
- Current inputs (outside WRF tree):
  - `WSPS/sample-case/input/spin_ups/Swindon/Input/SUEWS_Conductance.txt` codes 200/551–557, `gsModel=1`.
  - `SUEWS_SiteSelect.txt` CondCode/Code_* set to 200; `RunControl.nml` has `diagnose=1`, `SuppressWarnings=0`.
- WRF `namelist.input` for the case has `debug_level=100` for visibility. The model still reads the text tables at runtime, so missing/invalid conductance rows crash SUEWS.

## Patch attempt (isolated)
- Started `suews-patched-build/` to add a defensive gsModel fallback in `suews_phys_resist.f95`; build currently blocked in `suews_ctrl_sumin.f95` (type mismatch when compiling with `-Dwrf`). No patched `libsuews.a` installed; submodule untouched.

## Next steps proposed
1. **Prefer**: Bypass runtime text-table reads when SUEWS fields come from `wrfinput` (small WRF/SUEWS patch carried in coupling-automator), rerun `em_quarter_ss`.
2. Or, finish `suews-patched-build` and supply a patched `libsuews.a` that clamps invalid `gsModel` to 1, then relink WRF.
3. If staying input-only: swap in a known-good conductance/site pair from SUEWS fixtures (e.g., 2025a) but this keeps runtime dependence on text files.

## Artifacts
- Build logs: `compilation-20251121/compile_em_quarter_ss.log`, `compile_em_real.log`.
- Dev notes: `dev-notes/2025-11-21.md`.

## Open issue
- `gsModel` read as 0 at runtime causes SUEWS fatal; needs either input path correction or defensive handling.
