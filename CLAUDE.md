# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

WRF-SUEWS is a coupled atmospheric-urban surface model combining:
- **WRF** (Weather Research and Forecasting) model v4.7.1
- **SUEWS** (Surface Urban Energy and Water Balance Scheme) 2025.10.15

Both WRF and SUEWS are included as **git submodules** - never modify them directly.

## Repository Structure

```
.
├── WRF/                      # WRF submodule (do NOT modify)
├── SUEWS/                    # SUEWS submodule (do NOT modify)
├── coupling-automator/       # Core coupling automation scripts
├── WSPS/                     # WRF-SUEWS Pre-processor System
├── compilation-YYYYMMDD/     # Generated compilation directory
├── jasmin-config/           # JASMIN HPC configuration
└── docs/                    # Documentation
```

## Key Workflows

### 1. Initial Setup

After cloning, initialise submodules:
```bash
git submodule init
git submodule update
```

### 2. Building WRF-SUEWS

The coupling process is automated via the coupling-automator:

```bash
cd coupling-automator
make
```

This runs `automate_main.py` which:
1. Creates `compilation-YYYYMMDD/` directory (today's date)
2. Copies WRF source to the compilation directory
3. Applies coupling modifications from `changes_list.json`
4. Generates `module_sf_suewsdrv.F` by merging SUEWS source files
5. Copies wrapper files (`module_sf_suews.F`, `registry.suews`, `namelist.suews`)

**Important**: The script removes existing `compilation-YYYYMMDD/` if present.

### 3. Configure and Compile

After automation completes:

```bash
cd compilation-YYYYMMDD/
./configure
```

**Platform-specific configuration:**
- **JASMIN**: Option 15 (Intel compiler)
- **Apple Silicon (M-series)**: Option 15 (serial gcc/gfortran)

**Apple Silicon additional steps:**
- Set environment: `export NETCDF=/opt/homebrew/`
- Modify `configure.wrf` to add compatibility flags:
  ```bash
  FCBASEOPTS = $(FCBASEOPTS_NO_G) $(FCDEBUG) -fallow-invalid-boz -fallow-argument-mismatch
  ```

Then compile:
```bash
./compile em_real >& log.compile
```

On JASMIN, submit via SLURM: `sbatch sb-compile.sh`

### 4. Pre-processing with WSPS

The WRF-SUEWS Pre-processor System (WSPS) modifies `wrfinput_d0*.nc` files from WPS to include SUEWS-specific variables.

**Setup:**
```bash
cd WSPS
conda env create -f environment.yml
conda activate WSPS
```

**Configuration:**
Edit `wsps` section in `namelist.suews` to specify:
- Urban sites for spin-up (`urban_site_spin_up`)
- Domain numbers (`urban_domain_number`)
- Urban class thresholds (`urban_class_threshold`)
- Vegetation site (`veg_site_spin_up`)
- Start date and file paths

Add SUEWS site configuration files to `sample-case/input/spin_ups/` and WPS-generated `wrfinput_d0*.nc` files to `sample-case/input/`.

**Run:**
```bash
python wsps.py
```

Modified files appear in `output/final/`.

**Optional site-specific modifications:**
```bash
python wsps_site_specific.py
```

Uses custom modules in `utility/site_specific/` (see London/Swindon examples).

### 5. Running WRF-SUEWS

Copy modified inputs to run directory:
```bash
cp output/final/wrfinput_d0* compilation-YYYYMMDD/test/em_real/
cp WSPS/namelist.suews compilation-YYYYMMDD/test/em_real/
```

Ensure `namelist.input` sets `sf_surface_physics = 9` (SUEWS as LSM).

Run as normal WRF simulation.

## Architecture

### Coupling Mechanism

The coupling is implemented through automated source code modification:

1. **Registry System** (`registry.suews`): Defines SUEWS-specific state variables and metadata that WRF's automated code generation system uses to create data structures.

2. **WRF Modifications** (`changes_list.json`): JSON file specifying insertions into WRF source files:
   - `Registry.EM_COMMON`: Adds SUEWS package and variables
   - `module_physics_init.F`: Initialises SUEWS interface
   - `module_radiation_driver.F`: Integrates SUEWS into radiation calculations
   - `start_em.F`: Passes SUEWS variables during initialisation

3. **SUEWS Driver** (`module_sf_suewsdrv.F`): Auto-generated by merging all SUEWS source files from `SUEWS/src/suews/` into a single Fortran module for WRF.

4. **SUEWS Wrapper** (`module_sf_suews.F`): Fortran interface layer that calls SUEWS from WRF's surface physics framework.

### Key Python Scripts

**`automate_main.py`**:
- Main automation script
- Defines paths: `path_src_WRF`, `path_src_SUEWS`, `path_working`
- Orchestrates the entire coupling workflow

**`gen_suewsdrv.py`**:
- Parses `SUEWS/src/suews/Makefile` to extract module dependencies
- Merges SUEWS source files in correct dependency order
- Handles SUEWS 2025 structure: `UTILS`, `PHYS`, `DRIVER`, `TEST`, `WRF` modules
- Generates single `module_sf_suewsdrv.F` file

### SUEWS Structure Changes (2025)

Recent SUEWS repository migration:
- **Organisation**: Urban-Meteorology-Reading → UMEP-dev
- **Source location**: `SUEWS-SourceCode/` → `src/suews/`
- **Version handling**: Auto-generated for WRF coupling

## Environment Setup

### Main Environment (wrf-suews.yml)
```bash
conda env create -f wrf-suews.yml
conda activate wrf-suews
```

Includes: Python 3.9, pandas, xarray, supy, wrf-python, geopandas, etc.

### WSPS Environment (WSPS/environment.yml)
```bash
conda env create -f WSPS/environment.yml
conda activate WSPS
```

Includes: Python 3.7, supy 2019.4.15, pandas 0.24, xarray

## Platform-Specific Notes

### JASMIN HPC
- Use Intel compiler: `module load intel/20.0.0`
- Configuration option: 15
- Submit compilation via SLURM

### Apple Silicon (M-series)
- Requires Homebrew GCC 13/14
- NetCDF via Homebrew: `brew install gcc netcdf-c netcdf-fortran`
- Compiler flags required for GCC 10+ compatibility
- Configuration option: 15 (serial)

## Common Development Tasks

### Modifying Coupling Behaviour

1. **Add WRF variables**: Edit `registry.suews`
2. **Change WRF modifications**: Edit `changes_list.json`
3. **Update SUEWS wrapper**: Edit `module_sf_suews.F`
4. **Rebuild**: `cd coupling-automator && make`

### Updating SUEWS Version

```bash
cd SUEWS
git fetch
git checkout <new-version-tag>
cd ..
git add SUEWS
git commit -m "Update SUEWS to <version>"
```

Then rebuild coupling.

### Updating WRF Version

```bash
cd WRF
git fetch
git checkout <new-version-tag>
cd ..
git add WRF
git commit -m "Update WRF to <version>"
```

Review `changes_list.json` for compatibility with new WRF structure.

## Important Files

- `changes_list.json`: Defines all WRF source modifications
- `registry.suews`: WRF registry file for SUEWS variables
- `module_sf_suews.F`: SUEWS wrapper for WRF
- `namelist.suews`: SUEWS runtime configuration
- `configure.wrf`: Generated by WRF configure script (modify for Apple Silicon)

## Testing

No automated test suite exists. Manual testing workflow:
1. Build successfully on target platform
2. Run WSPS on sample case
3. Execute short WRF-SUEWS simulation
4. Verify output files and energy balance closure

## Known Issues

- Symlinks in WRF may not copy correctly during automation (non-critical)
- GCC 10+ requires compatibility flags for legacy Fortran (BOZ, argument mismatches)
- WSPS requires older Python (3.7) and specific supy version (2019.4.15)

## Documentation

- Main README: Project overview and compilation guide
- `coupling-automator/README.md`: Automation details
- `WSPS/README.md`: Pre-processor configuration and usage
- SUEWS docs: [UMEP-dev/SUEWS](https://github.com/UMEP-dev/SUEWS)
- WRF docs: [WRF Online Tutorial](https://www2.mmm.ucar.edu/wrf/OnLineTutorial/)
